# 身内で遊ぶゲームのサーバーを自宅マシンで建てるための準備

MinecraftやArkなどのゲームを、レンタルサーバーを借りずに自宅で建てたいときの必要な手順のまとめ

サーバーを建てる際の作業は大きく以下の2つに分けられる。

1. サーバープログラムを実行する
1. サーバー - クライアント間の経路を確立する

基本的に1については各ゲームで用意されているプログラムを実行するだけで建てられることが多い。サーバーを上手く立てられないのは、__2.の接続経路設定(ポート設定やセキュリティ設定)で引っかかってる場合がほとんど__ なので、そこを適切に設定できるようになれば鯖建ての敷居は大きく下がる。

## はじめに

サーバーを建てる大前提として、__サーバー管理者は自宅のルーター（デフォルトゲートウェイ）にアクセスできる必要がある。__

デフォルトゲートウェイはipconfigなどのコマンドで調べることができ（大体「192.168.1.1」とか「192.168.10.1」とかそんな感じ）、webブラウザのURL欄にそのIPを入力するとほとんどのルータは設定ページが開かれる。

ただし、このときルーターのログインIDとパスワードが分からなければ、設定を変更できないためこの先の話が進まない。そのため、まずはルーターにアクセスでき設定を変更できそうかの確認をしよう。

__以降はルーターの設定を変更できる前提で話を進める__

## 1. サーバープログラムの実行

ここについては公式や解説サイトを見たほうが早い。必要なのは大体、前提ソフトのインストール(例:MinecraftだとJava)と、適切なサーバー設定、そしてサーバーの実行。

大体のゲームでは起動用のスクリプトやコマンドを実行すればそのまま動作するが、念の為各ゲームごとに起動手順を調べておこう。サーバーがうまく起動していなければそもそも遊べない。

- Minecraft：https://minecraft.wiki/w/Tutorial:Setting_up_a_Java_Edition_server
- Ark：https://ark.fandom.com/wiki/Dedicated_server_setup
- Palworld：https://docs.palworldgame.com/ja/getting-started/deploy-dedicated-server/
- Enshrouded：https://enshrouded.fandom.com/wiki/Dedicated_Server_Hosting

## 2. サーバーとクライアント(参加者)間の経路

クライアントがサーバーに接続するとき、大体のゲームではサーバーのグローバルIPとポートを入力するだけでよい。

このとき、クライアントからの接続要求は

1. クライアントマシンのファイアウォールなど
1. クライアントのデフォルトゲートウェイ
1. サーバーのデフォルトゲートウェイ
1. サーバーマシンのファイアウォールなど

を経由してサーバーへ届く。そのため、どこか一つでもファイアウォールやポート設定などで弾かれるとサーバーへのアクセスがうまく出来なくなってしまう。

以降はそれぞれにおける設定手順を記載していく（とはいえ、クライアント側は意図的に何か設定を変更していない限り、必要な操作は基本的に無い）。

# サーバー側の設定

サーバーマシン（PCなど）とデフォルトゲートウェイ（ルーター）両方に設定が必要

## サーバーマシンの設定（ファイアウォール、ローカルIPの固定）

### ポート開放

サーバーを建てるマシンのポート設定を行う。ゲームのサーバープログラムで設定したポートが開いていなければ、そもそもサーバーマシンへのアクセスができない。

設定の仕方は調べたら出てくる。検索結果の中にはポートを全開放するような設定の仕方も見受けられるが、基本は使用するポートのみを開放したほうがよい。

- Windows([参考](https://www.pfu.ricoh.com/imaging/downloads/manual/ss_webhelp/jp/help/webhelp/topic/refer_firewall.html))：ファイアウォール設定から「送信の規則」と「受信の規則」に適当な名前で新規に作成する

デフォルトだとマイクラは25565、ARKは27015, 7777, 7778、Palworldは8211あたりだが、サーバーの設定ファイルで変えられるので開放するポート番号は環境に合わせよう。
（一応セキュリティ的に、デフォルトから変えておいたほうが多少はマシ）

この設定が終われば、少なくともローカルネットワーク内の別PCからはサーバーマシンへアクセスできるようになる（自宅のネットワーク内で、マシンAにサーバーを建てて、マシンBでゲームを起動してサーバーへ接続、的な）。

### ローカルIPアドレスの固定

大体の家庭環境であればルーターがローカル内のIPアドレスを動的に行うような設定であり、サーバーマシンやルーターを再起動した際にIPアドレスが変わってしまう。
後述のルーターの設定で地味に困るため、サーバーマシンのローカルIPアドレスを固定してしまおう。

ここで設定した固定IPはメモしておく。ルーターの設定でも必要だし、自宅内でサーバーとゲームをプレイするマシンが違う場合アクセスするのにも必要。

※ ぶっちゃけこの設定はサーバーマシン側ではなく、ルーターのDHCP固定割り当て設定などで実施したほうがよい。サーバーマシンのローカルIPを固定できるならどの方法でも問題ない

## サーバーのデフォルトゲートウェイの設定（ルーター）

先述の通り、ローカルネットワークに無いマシンからはグローバルIPを使用してアクセスする必要がある。

しかし、ルーターへ適切に設定がされていない場合、ルーターは外部から受け取った通信をローカルネットワーク内のどのマシンに渡してよいのか分からず接続できない可能性がある。

そこでポートマッピングやポートフォワーディングと呼ばれる設定を行い、指定のポートへの通信をサーバーマシンへ送れるようにする。

この設定を行うことにより、外部からグローバルIPでのアクセス要求がルーターに届くと、それをサーバーマシンへ転送してくれて接続できる。

### 設定方法

ルーターの設定ページを開けたら、ポートフォワーディングやポートマッピングの設定箇所を探す。

どのポートにきた通信をどのローカルIPへ転送するか設定できるため、ゲームで使用するポートの転送先を先程設定したサーバーマシンの固定IPに指定する。

TDP/UDPの設定はゲームによって異なるが、とりあえず両方設定していれば大丈夫
